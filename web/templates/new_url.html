{% extends "layout.html" %}
{% block title %}Home{% endblock %}
{% block body %}


<script type="text/javascript">

// try to visualize item relations as social network graph
//window.onload = function() {
//	var nodes = [{node:0, name: "idea-1", fixed:false}, {node:1, name: "idea-2", fixed:false}, {node:2, name: "stakeholder-1", fixed:false}]
//	var links = [{source:2, target:0}, {source:2, target:1}]

// load the data
d3.json("/d3js/json/", function(error, graph) {
	if (error) return console.warn(error);
	
	var nodes = graph.nodes
	var links = graph.links
	// console.warn("graph.nodes: " + graph.nodes)
		
	var w = 500;
	var h = 500;

	var svg = d3.select("body")
				.select(".main") // my main div
                .append("svg")
                .attr("width", w)
                .attr("height", h)
                .attr('preserveAspectRatio', 'xMinYMin slice') 
                .append('g');
	
	// Tooltip
	var div = d3.select("body")
				//.select(".main") // my main div
				.append("div")	
			    .attr("class", "tooltip")				
			    .style("opacity", 0);
	
	var force = self.force = d3.layout.force()
									  .nodes(nodes)
									  .links(links)
									  .gravity(0.05)
									  .distance(100)
									  .charge(-100)
									  .size([w,h])
									  .start();

	// build the arrow.
	svg.append("svg:defs").selectAll("marker")
						    .data(["end"])      // Different link/path types can be defined here
						  .enter().append("svg:marker")    // This section adds in the arrows
						    .attr("id", String)
						    .attr("viewBox", "0 -5 10 10")
						    .attr("refX", 15)
						    .attr("refY", -1.5)
						    .attr("markerWidth", 6)
						    .attr("markerHeight", 6)
						    .attr("orient", "auto")
						  .append("svg:path")
						    .attr("d", "M0,-5L10,0L0,5");

	var link = svg.selectAll(".link")
				  .data(links)
				  .enter().append("line")
				  .attr("class", "link")
				  .attr("marker-end", "url(#end)")
				  .attr("x1", function(d) { return d.source.x; })
				  .attr("y1", function(d) { return d.source.y; })
				  .attr("x2", function(d) { return d.target.x; })
				  .attr("y2", function(d) { return d.target.y; });
			
console.log(link);
	  
	var node_drag = d3.behavior.drag()
							   .on("dragstart", dragstart)
							   .on("drag", dragmove)
							   .on("dragend", dragend);

	function dragstart(d, i) {
		force.stop(); // stops the force auto positioning before you start dragging
	}

	function dragmove(d, i) {
		d.px += d3.event.dx;
		d.py += d3.event.dy;
		d.x += d3.event.dx;
		d.y += d3.event.dy; 
		tick(); 
	}

	function dragend(d, i) {
		d.fixed = true; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
		tick();
		force.resume();
	}
	
	// nodes as circles with links and tooltips
	var node = svg.selectAll("a.node")
			      .data(nodes)
			    .enter().append("a")
			      .attr("class", "node")
			      .attr("xlink:href", function(d){ return "/" + d.name.split('-')[0] + "/" + d.name + "/"})
			    .append("circle")
				  .attr("class", "node")
				  .attr("r", 4.5)
				.call(node_drag)
				  .attr("title", function(d){ return "<a href='/" + d.name + "/'>&nbsp;</a><"})
				  .on("mouseover", function(d) {		
		            div.transition()		
		                .duration(200)		
		                .style("opacity", .9);		
		            div	.html(d.name)	
		                .style("left", (d3.event.pageX) + "px")		
		                .style("top", (d3.event.pageY - 28) + "px");	
		          })					
		          .on("mouseout", function(d) {		
		            div.transition()		
		                .duration(500)		
		                .style("opacity", 0);	
		          });

	// @see: http://stackoverflow.com/questions/7306250/does-force-directed-layout-of-d3-js-support-image-as-node
	node.append("image")
	    .attr("xlink:href", "/img/User_16x16.png")
	    .attr("x", "-8px")
	    .attr("y", "-8px")
	    .attr("width", "16px")
	    .attr("height", "16px");

	
	force.on("tick", tick);

	function tick() {
      link.attr("x1", function(d) { return d.source.x; })
	      .attr("y1", function(d) { return d.source.y; })
	      .attr("x2", function(d) { return d.target.x; })
	      .attr("y2", function(d) { return d.target.y; });

	  node.attr("cx", function(d) { return d.x; })
	      .attr("cy", function(d) { return d.y; });
	}
});

</script>

<!-- <p>New paragraph!</p> -->

<!--   <h2>Submit URL</h2>
  <form action="" method=post>
    {% if error %}
      <p class=error><strong>Error:</strong> {{ error }}
    {% endif %}
    <p>URL:
      <input type=text name=url value="{{ url }}" class=urlinput>
      <input type=submit value="Shorten">
  </form> -->
  
<!-- <svg width="500" height="50">
	<rect x="0" y="0" width="50" height="50"/>
	<circle cx="150" cy="25" r="25"/>
	<circle cx="100" cy="25" r="22" fill="yellow" stroke="orange" stroke-width="5"/>
	<ellipse cx="350" cy="25" rx="100" ry="25"/>
	<line x1="0" y1="0" x2="500" y2="50" stroke="black"/>
	<text x="150" y="45" font-family="sans-serif"
 			font-size="25" fill="gray">Easy-peasy</text>
</svg>
 -->  
{% endblock %}
